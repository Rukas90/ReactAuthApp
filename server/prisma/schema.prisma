generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String?
  is_verified   Boolean
  created_at    DateTime @default(now())

  refreshTokens  RefreshToken[]
  oauths         OAuth[]
  sessions       UserSession[]
  mfaEnrollments MfaEnrollment[]
  verifications  Verification[]
}

model OAuth {
  id          String  @id @default(uuid())
  provider_id String
  provider    String
  username    String?
  user        User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id     String

  @@unique([provider, provider_id])
  @@index([user_id])
}

model MfaEnrollment {
  id          String    @id @default(uuid())
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id     String
  method      String
  configured  Boolean   @default(false)
  credentials Json?
  created_at  DateTime  @default(now())
  expires_At  DateTime?

  @@unique([user_id, method])
  @@index([user_id])
}

model RefreshToken {
  id          String    @id @default(uuid())
  family_id   String
  token_hash  String    @unique
  lookup_hash String    @unique
  created_at  DateTime  @default(now())
  expires_at  DateTime
  revoked_at  DateTime?
  revoked     Boolean   @default(false)
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id     String

  @@index([lookup_hash])
  @@index([user_id, family_id])
}

model UserSession {
  id               String   @id @default(uuid())
  family_id        String   @unique
  user_agent       String
  ip_address       String
  location         String?
  created_at       DateTime @default(now())
  expires_at       DateTime
  last_accessed_at DateTime @default(now())
  revoked          Boolean  @default(false)
  user_id          String
  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, family_id])
  @@index([user_id])
}

model Verification {
  id                String   @id @default(uuid())
  dispatch_type     String
  payload_encrypted String?
  code_hash         String   @unique
  lookup_hash       String   @unique
  created_at        DateTime @default(now())
  expires_at        DateTime
  user_id           String
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, dispatch_type])
  @@index([user_id, lookup_hash])
}
